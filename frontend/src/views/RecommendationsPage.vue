<template>
  <div class="recommendations-page">
    <header class="glass-header">
      <div class="header-content">
        <div class="logo">å¥åº·ç”Ÿæ´»</div>
        <nav class="main-nav">
          <router-link to="/dashboard" class="nav-item">é¦–é¡µ</router-link>
          <router-link to="/records" class="nav-item">è®°å½•</router-link>
          <router-link to="/recommendations" class="nav-item active">æ¨è</router-link>
          <router-link to="/reports" class="nav-item">æŠ¥å‘Š</router-link>
        </nav>
        <div class="user-menu" @click="toggleDropdown" ref="userMenuRef">
          <div class="user-info">
            <div class="avatar">
              <UserAvatar />
            </div>
            <span class="username">{{ username }}</span>
            <span class="dropdown-arrow" :class="{ 'rotated': isDropdownVisible }">â–¼</span>
          </div>
          
          <!-- ä¸‹æ‹‰èœå• -->
          <div v-if="isDropdownVisible" class="user-dropdown">
            <div class="dropdown-header">
              <div class="header-info">
                <span class="signed-in">ç™»å½•ä¸º</span>
                <strong>{{ username }}</strong>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <router-link to="/profile" class="dropdown-item">
              <span class="item-icon">ğŸ‘¤</span>
              ä¸ªäººä¸»é¡µ
            </router-link>
            <router-link to="/settings" class="dropdown-item">
              <span class="item-icon">âš™ï¸</span>
              è®¾ç½®
            </router-link>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" @click="handleLogout">
              <span class="item-icon">ğŸšª</span>
              é€€å‡º
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="recommendations-content">
      <!-- å¥åº·å»ºè®®å¡ç‰‡ -->
      <section class="health-tips">
        <h2>ä»Šæ—¥å¥åº·å»ºè®®</h2>
        <div class="tips-grid">
          <div class="tip-card">
            <div class="tip-icon">ğŸ’ª</div>
            <h3>è¿åŠ¨å»ºè®®</h3>
            <p>æ ¹æ®æ‚¨çš„è¿åŠ¨è®°å½•ï¼Œå»ºè®®ä»Šå¤©è¿›è¡Œ30åˆ†é’Ÿçš„ä¸­ç­‰å¼ºåº¦è¿åŠ¨ï¼Œå¦‚å¿«èµ°æˆ–æ¸¸æ³³ã€‚</p>
          </div>
          <div class="tip-card">
            <div class="tip-icon">ğŸ½ï¸</div>
            <h3>é¥®é£Ÿå»ºè®®</h3>
            <p>ä¿æŒå‡è¡¡é¥®é£Ÿï¼Œå¤šåƒè”¬èœæ°´æœï¼Œé€‚é‡æ‘„å…¥è›‹ç™½è´¨ï¼Œé¿å…è¿‡åº¦åŠ å·¥é£Ÿå“ã€‚</p>
          </div>
          <div class="tip-card">
            <div class="tip-icon">ğŸ˜´</div>
            <h3>ç¡çœ å»ºè®®</h3>
            <p>ä¿æŒè§„å¾‹çš„ä½œæ¯æ—¶é—´ï¼Œç¡®ä¿7-8å°æ—¶çš„ä¼˜è´¨ç¡çœ ï¼Œç¡å‰é¿å…ä½¿ç”¨ç”µå­è®¾å¤‡ã€‚</p>
          </div>
          <div class="tip-card">
            <div class="tip-icon">ğŸ§˜</div>
            <h3>å¿ƒç†å»ºè®®</h3>
            <p>ä¿æŒç§¯æä¹è§‚çš„å¿ƒæ€ï¼Œé€‚å½“è¿›è¡Œå†¥æƒ³æˆ–æ·±å‘¼å¸ç»ƒä¹ ï¼Œç¼“è§£å‹åŠ›ã€‚</p>
          </div>
        </div>
      </section>

      <!-- ä¸ªæ€§åŒ–æ¨è -->
      <section class="personalized-recommendations">
        <h2>ä¸ºæ‚¨æ¨è</h2>
        <div class="recommendations-grid">
          <div class="recommendation-card">
            <div class="card-header">
              <span class="card-icon">ğŸƒ</span>
              <h3>è¿åŠ¨è®¡åˆ’</h3>
            </div>
            <div class="card-content">
              <ul class="recommendation-list">
                <li>å‘¨ä¸€ï¼š30åˆ†é’Ÿå¿«èµ°</li>
                <li>å‘¨ä¸‰ï¼š45åˆ†é’Ÿæ¸¸æ³³</li>
                <li>å‘¨äº”ï¼š60åˆ†é’Ÿç‘œä¼½</li>
                <li>å‘¨æ—¥ï¼š40åˆ†é’Ÿéª‘è¡Œ</li>
              </ul>
            </div>
          </div>
          <div class="recommendation-card">
            <div class="card-header">
              <span class="card-icon">ğŸ¥—</span>
              <h3>è¥å…»é£Ÿè°±</h3>
            </div>
            <div class="card-content">
              <ul class="recommendation-list">
                <li>æ—©é¤ï¼šå…¨éº¦é¢åŒ… + é¸¡è›‹ + ç‰›å¥¶</li>
                <li>åˆé¤ï¼šç³™ç±³é¥­ + é¸¡èƒ¸è‚‰ + è¥¿å…°èŠ±</li>
                <li>æ™šé¤ï¼šä¸‰æ–‡é±¼ + è—œéº¦ + æ²™æ‹‰</li>
                <li>åŠ é¤ï¼šæ°´æœ + åšæœ</li>
              </ul>
            </div>
          </div>
          <div class="recommendation-card">
            <div class="card-header">
              <span class="card-icon">ğŸ“š</span>
              <h3>å¥åº·çŸ¥è¯†</h3>
            </div>
            <div class="card-content">
              <ul class="recommendation-list">
                <li>äº†è§£è¿åŠ¨å¼ºåº¦ä¸å¿ƒç‡çš„å…³ç³»</li>
                <li>å­¦ä¹ è¥å…»å‡è¡¡çš„é¥®é£Ÿæ­é…</li>
                <li>æŒæ¡å‹åŠ›ç®¡ç†æŠ€å·§</li>
                <li>äº†è§£ç¡çœ è´¨é‡çš„å½±å“å› ç´ </li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- å¥åº·ç›®æ ‡ -->
      <section class="health-goals">
        <h2>å¥åº·ç›®æ ‡</h2>
        <div class="goals-grid">
          <div class="goal-card">
            <div class="goal-progress">
              <div class="progress-circle">
                <span class="progress-value">75%</span>
              </div>
            </div>
            <h3>æ¯å‘¨è¿åŠ¨ç›®æ ‡</h3>
            <p>ç›®æ ‡ï¼š150åˆ†é’Ÿ</p>
            <p>å·²å®Œæˆï¼š112åˆ†é’Ÿ</p>
          </div>
          <div class="goal-card">
            <div class="goal-progress">
              <div class="progress-circle">
                <span class="progress-value">60%</span>
              </div>
            </div>
            <h3>ç¡çœ è´¨é‡ç›®æ ‡</h3>
            <p>ç›®æ ‡ï¼šä¼˜è´¨ç¡çœ 7å°æ—¶</p>
            <p>è¾¾æ ‡å¤©æ•°ï¼š4/7å¤©</p>
          </div>
          <div class="goal-card">
            <div class="goal-progress">
              <div class="progress-circle">
                <span class="progress-value">85%</span>
              </div>
            </div>
            <h3>é¥®é£Ÿå‡è¡¡ç›®æ ‡</h3>
            <p>ç›®æ ‡ï¼šæ¯æ—¥è¥å…»å‡è¡¡</p>
            <p>è¾¾æ ‡å¤©æ•°ï¼š6/7å¤©</p>
          </div>
        </div>
      </section>
    </main>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import UserAvatar from '../components/UserAvatar.vue'
import useUserStore from '../stores/userStore'
import axios from 'axios'

const router = useRouter()
const userStore = useUserStore()
const isDropdownVisible = ref(false)
const userMenuRef = ref(null)
const loading = ref(true)
const recommendations = ref({
  season: 'spring',
  healthSummary: {
    sleepQuality: 'normal',
    commonIssues: [],
    moodStatus: 'neutral',
    exerciseLevel: 'medium'
  },
  recommendations: {
    food: [],
    exercise: [],
    lifestyle: []
  }
})

const username = computed(() => userStore.state.username)

// è·å–æ¨èæ•°æ®
const fetchRecommendations = async () => {
  loading.value = true
  try {
    const response = await axios.get('http://localhost:5000/api/recommendations', {
      headers: {
        'Authorization': `Bearer ${userStore.state.token}`
      }
    })
    recommendations.value = response.data
    console.log('è·å–åˆ°çš„æ¨èæ•°æ®:', recommendations.value)
  } catch (error) {
    console.error('è·å–æ¨èæ•°æ®å¤±è´¥:', error)
  } finally {
    loading.value = false
  }
}

// è·å–å­£èŠ‚å›¾æ ‡
const getSeasonIcon = (season) => {
  const icons = {
    spring: 'ğŸŒ¸',
    summer: 'â˜€ï¸',
    autumn: 'ğŸ‚',
    winter: 'â„ï¸'
  }
  return icons[season] || 'ğŸŒ'
}

// è·å–å­£èŠ‚åç§°
const getSeasonName = (season) => {
  const names = {
    spring: 'æ˜¥',
    summer: 'å¤',
    autumn: 'ç§‹',
    winter: 'å†¬'
  }
  return names[season] || 'å½“å‰'
}

// è·å–ç¡çœ è´¨é‡æ–‡æœ¬
const getSleepQualityText = (quality) => {
  const texts = {
    good: 'è‰¯å¥½',
    normal: 'ä¸€èˆ¬',
    bad: 'ä¸ä½³'
  }
  return texts[quality] || 'ä¸€èˆ¬'
}

// è·å–ç¡çœ è´¨é‡æ ·å¼ç±»
const getSleepQualityClass = (quality) => {
  const classes = {
    good: 'status-good',
    normal: 'status-normal',
    bad: 'status-bad'
  }
  return classes[quality] || 'status-normal'
}

// è·å–æƒ…ç»ªçŠ¶æ€æ–‡æœ¬
const getMoodStatusText = (status) => {
  const texts = {
    positive: 'ç§¯æ',
    neutral: 'å¹³ç¨³',
    negative: 'æ¶ˆæ'
  }
  return texts[status] || 'å¹³ç¨³'
}

// è·å–æƒ…ç»ªçŠ¶æ€æ ·å¼ç±»
const getMoodStatusClass = (status) => {
  const classes = {
    positive: 'status-good',
    neutral: 'status-normal',
    negative: 'status-bad'
  }
  return classes[status] || 'status-normal'
}

// è·å–è¿åŠ¨æ°´å¹³æ–‡æœ¬
const getExerciseLevelText = (level) => {
  const texts = {
    high: 'æ´»è·ƒ',
    medium: 'é€‚ä¸­',
    low: 'è¾ƒå°‘'
  }
  return texts[level] || 'é€‚ä¸­'
}

// è·å–è¿åŠ¨æ°´å¹³æ ·å¼ç±»
const getExerciseLevelClass = (level) => {
  const classes = {
    high: 'status-good',
    medium: 'status-normal',
    low: 'status-warning'
  }
  return classes[level] || 'status-normal'
}

// è·å–å¥åº·é—®é¢˜æ–‡æœ¬
const getHealthIssueText = (issue) => {
  const texts = {
    sleep_well: 'ç¡çœ å……è¶³',
    sleep_bad: 'ç¡çœ ä¸è¶³',
    appetite_good: 'èƒƒå£å¥½',
    appetite_bad: 'æ²¡èƒƒå£',
    energetic: 'ç²¾åŠ›å……æ²›',
    fatigue: 'ç–²åŠ³ä¹åŠ›',
    muscle_sore: 'è‚Œè‚‰é…¸ç—›',
    headache: 'å¤´ç–¼',
    throat: 'å’½å–‰ä¸é€‚',
    stomach: 'èƒƒéƒ¨ä¸é€‚',
    cold: 'æ„Ÿå†’å‘çƒ§',
    allergy: 'è¿‡æ•'
  }
  return texts[issue] || issue
}

const toggleDropdown = () => {
  isDropdownVisible.value = !isDropdownVisible.value
}

const handleClickOutside = (event) => {
  if (userMenuRef.value && !userMenuRef.value.contains(event.target)) {
    isDropdownVisible.value = false
  }
}

const handleLogout = () => {
  userStore.logout()
  router.push('/login')
}

onMounted(() => {
  fetchRecommendations()
  document.addEventListener('click', handleClickOutside)
})

onUnmounted(() => {
  document.removeEventListener('click', handleClickOutside)
})
</script>

<style scoped>
.recommendations-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #f8fafc 0%, #e0f7ff 100%);
}

.glass-header {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  padding: 1rem 2rem;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  font-size: 1.5rem;
  font-weight: 600;
  color: #1e293b;
}

.main-nav {
  display: flex;
  gap: 2rem;
}

.nav-item {
  color: #64748b;
  text-decoration: none;
  font-weight: 500;
  transition: color 0.3s ease;
}

.nav-item:hover {
  color: #3b82f6;
}

.nav-item.active {
  color: #3b82f6;
}

.user-menu {
  position: relative;
  cursor: pointer;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.avatar {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  overflow: hidden;
}

.username {
  color: #1e293b;
  font-weight: 500;
}

.dropdown-arrow {
  font-size: 0.75rem;
  color: #64748b;
  transition: transform 0.3s ease;
}

.dropdown-arrow.rotated {
  transform: rotate(180deg);
}

.user-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border-radius: 0.75rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  min-width: 200px;
  margin-top: 0.5rem;
  z-index: 1000;
}

.dropdown-header {
  padding: 1rem;
  border-bottom: 1px solid #e2e8f0;
}

.header-info {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.signed-in {
  font-size: 0.875rem;
  color: #64748b;
}

.dropdown-divider {
  height: 1px;
  background: #e2e8f0;
  margin: 0.5rem 0;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  color: #1e293b;
  text-decoration: none;
  transition: background-color 0.3s ease;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  cursor: pointer;
}

.dropdown-item:hover {
  background-color: #f8fafc;
}

.item-icon {
  font-size: 1.25rem;
}

.recommendations-content {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 2rem;
}

section {
  margin-bottom: 3rem;
}

h2 {
  color: #1e293b;
  font-size: 1.75rem;
  margin-bottom: 1.5rem;
  font-weight: 600;
}

.tips-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
}

.tip-card {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
}

.tip-card:hover {
  transform: translateY(-5px);
}

.tip-icon {
  font-size: 2rem;
  margin-bottom: 1rem;
}

.tip-card h3 {
  color: #1e293b;
  font-size: 1.25rem;
  margin-bottom: 0.75rem;
}

.tip-card p {
  color: #64748b;
  line-height: 1.6;
}

.recommendations-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
}

.recommendation-card {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.card-icon {
  font-size: 1.5rem;
}

.card-header h3 {
  color: #1e293b;
  font-size: 1.25rem;
  margin: 0;
}

.recommendation-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.recommendation-list li {
  color: #64748b;
  padding: 0.5rem 0;
  border-bottom: 1px solid #e2e8f0;
}

.recommendation-list li:last-child {
  border-bottom: none;
}

.goals-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
}

.goal-card {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  text-align: center;
}

.goal-progress {
  margin-bottom: 1rem;
}

.progress-circle {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: #f0f9ff;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
}

.progress-circle::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: conic-gradient(#3b82f6 var(--progress), #e2e8f0 0deg);
  --progress: 75%;
}

.progress-value {
  position: relative;
  font-size: 1.5rem;
  font-weight: 600;
  color: #1e293b;
}

.goal-card h3 {
  color: #1e293b;
  font-size: 1.25rem;
  margin-bottom: 0.75rem;
}

.goal-card p {
  color: #64748b;
  margin: 0.25rem 0;
}

@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    gap: 1rem;
  }

  .main-nav {
    gap: 1rem;
  }

  .recommendations-content {
    padding: 0 1rem;
  }

  .tips-grid,
  .recommendations-grid,
  .goals-grid {
    grid-template-columns: 1fr;
  }
}
</style> 